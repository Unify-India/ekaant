<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/manager/student-applications"></ion-back-button>
    </ion-buttons>
    <ion-title>Application Details</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  @if (isLoading) {
  <div class="ion-text-center ion-padding">
    <ion-spinner></ion-spinner>
    <p>Loading application...</p>
  </div>
  } @else if (application) {
  <div class="details-container">
    <!-- Student Details -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Student Information</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-label>
              <p>Name</p>
              <h2>{{ application.studentName }}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <p>Email</p>
              <h2>{{ application.studentEmail }}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <p>Phone</p>
              <h2>{{ application.studentPhone || 'N/A' }}</h2>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Plan & Slot Verification -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Plan & Slot Verification</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-icon slot="start" name="time-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Selected Plan</p>
              <h2>{{ application.selectedPlan?.planName }}</h2>
              <p>Time Slot: <ion-text color="dark">{{ application.selectedPlan?.timeSlot }}</ion-text></p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Enrollment & Payment -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Enrollment & Payment</ion-card-title>
      </ion-card-header>
      <ion-card-content>
         <ion-input
            class="ion-margin-bottom"
            label="Payment Amount *"
            labelPlacement="floating"
            fill="outline"
            type="number"
            [(ngModel)]="paymentAmount"
          ></ion-input>

          <ion-grid class="ion-no-padding">
            <ion-row>
              <ion-col size="6" class="ion-padding-end">
                <ion-input
                  class="ion-margin-bottom"
                  label="Start Date *"
                  labelPlacement="floating"
                  fill="outline"
                  type="date"
                  [(ngModel)]="startDate"
                  (ionChange)="onStartDateChange($event)"
                ></ion-input>
              </ion-col>
              <ion-col size="6" class="ion-padding-start">
                <ion-input
                  class="ion-margin-bottom"
                  label="End Date *"
                  labelPlacement="floating"
                  fill="outline"
                  type="date"
                  [value]="endDate"
                  readonly="true"
                ></ion-input>
              </ion-col>
            </ion-row>
          </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Seat Allotment -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Seat Allotment</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-toggle [(ngModel)]="autoAllot" (ionChange)="onAutoAllotChange($event)">
              Auto Allot Seat
            </ion-toggle>
          </ion-item>

          <ion-item>
            <ion-select
              label="Select Seat"
              labelPlacement="floating"
              [(ngModel)]="selectedSeatId"
              [disabled]="autoAllot"
              placeholder="Choose a seat"
            >
              @for (seat of seats; track seat.id) {
              <ion-select-option [value]="seat.id" [disabled]="seat.status !== 'active'">
                Seat {{ seat.seatNumber }} ({{ seat.status }})
              </ion-select-option>
              }
            </ion-select>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    @if (application.applicationStatus === 'pending') {
    <div class="ion-padding-horizontal ion-margin-top">
      <ion-button expand="block" color="success" (click)="onAccept()" [disabled]="isLoading">
        @if (!isLoading) {
        <ion-icon slot="start" name="checkmark-circle"></ion-icon>
        } @else {
        <ion-spinner slot="start" name="crescent"></ion-spinner>
        }
        {{ isLoading ? 'Allocating...' : 'Allocate & Accept' }}
      </ion-button>
    </div>
    }
  </div>
  } @else {
  <div class="ion-text-center ion-padding">
    <p>Application not found.</p>
  </div>
  }
</ion-content>